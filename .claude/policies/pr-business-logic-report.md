---
description: Rules for generating comprehensive business logic reports from PR analysis
---

# PRビジネスロジックレポート生成ルール

このドキュメントは、PRから関連機能を特定し、その機能のビジネスロジックを調査してレポートを生成する際の原則とルールを定義します。

> **注意**: このドキュメント内の例はすべて**記載形式の見本**です。実際のレポートでは、プロジェクト固有の内容に置き換えてください。

## セクション0: 基本原則

### 0.1 コードベース原則の遵守（CRITICAL）

**原則**: ビジネスロジックレポート生成は**実装コードのみ**を根拠とする。

PRの差分は「**どの機能を調査すべきか**を特定するきっかけ」として使用する。
レポートに含めるビジネスロジック、バリデーションルール、データ構造は、**すべて実装コードから抽出**すること。

**誤り例**:
- PRの説明文に「[機能名]を追加」と書かれているから、その機能について記載
- Issue本文に「[チェック名]」と書かれているから、ロジックを推測

**正しい例**:
- Controllerで `[validate関数名]()` を発見し、その中のチェック処理を分析
- SQLクエリで `[カラム名]` を参照していることを確認し、その意味を分析

### 0.2 調査スコープの決定方法（CRITICAL）

**原則**: PRの差分は**関連機能を特定するきっかけに過ぎない**。調査対象は**その機能（ユースケース）に関するすべてのビジネスロジック**であり、PR変更内容の詳細は調査範囲の決定に影響しない。

#### Step 1: 機能（ユースケース）を特定

PRの変更が「どの機能を実現するためのものか」を特定する。
機能とは「ユーザーが実行する1つの操作・目的」の単位。

**特定方法の例**:
| PRの変更内容 | 属する機能（ユースケース） |
|-------------|------------------------|
| [判定メソッド追加]＋[CSVヘッダー変更] | [詳細CSVダウンロード] |
| [申込画面のバリデーション追加] | [申込登録] |
| [判定ロジック修正] | [結果登録] |

#### Step 2: その機能の処理全体を調査対象とする

特定した機能について、以下を網羅的に調査する：
- **入力**: どのデータを参照するか
- **処理**: どのような変換・計算・判定を行うか
- **出力**: 何を生成・表示するか
- **バリデーション・ビジネスルール**: どのようなチェック・制約があるか
- **エラーハンドリング**: どのようなエラーが発生しうるか

#### 調査範囲の境界

**調査対象**: 特定した機能の処理全体

**調査対象外**: その機能が参照するデータの「他の機能での作成・更新処理」

**例**:
- 機能:「詳細CSVダウンロード」の場合
  - 調査する: CSVに出力される項目、集計ロジック、判定ロジック、出力フォーマット
  - 調査しない: データがどう登録されるか（別機能）

- 機能:「結果登録」の場合
  - 調査する: 登録処理、バリデーション、判定ロジック、データ更新
  - 調査しない: 登録されたデータがCSVでどう出力されるか（別機能）

**重要**: その機能自体が作成・更新処理であれば、当然それらを調査すること。

### 0.3 コード探索の徹底

コードベース原則に従うため、特定した機能に関連する以下のファイルを**すべて探索**すること：

| ファイルカテゴリ | 探索目的 |
|----------------|---------|
| エントリーポイント（Controller/Handler/Router等） | エンドポイント、権限チェック、分岐ロジック、ビジネスロジック呼び出し |
| ビジネスロジック層（Service/UseCase/Domain等） | ビジネスロジックの詳細、計算処理、データ操作 |
| プレゼンテーション層（View/Template/Component等） | 画面項目、表示条件、フロントエンド機能 |
| バリデーション定義（Validator/Schema/Request等） | バリデーションルール、必須/任意項目、条件付き必須 |
| データモデル（Model/Entity/Repository等） | リレーション、スコープ、データアクセス |
| 定数・列挙型（Enum/Constants/Config等） | 定数定義、コード体系、選択肢 |
| DB定義（Migration/Schema/DDL等） | DB構造、初期データ |

> **注**: 上記はフレームワーク非依存の抽象カテゴリです。プロジェクトのアーキテクチャに応じて、対応するファイルを特定してください。

### 0.4 テンプレート構造の厳守（MANDATORY）

**原則**: 出力するレポートは、**テンプレートファイルの構造を完全に遵守**すること。

#### 0.4.1 禁止事項

以下の行為は**絶対に禁止**：
1. **セクション構造の変更**: テンプレートのセクション順序を変更する
2. **テーブル構造の変更**: テンプレートで定義されたテーブルの列数・列名を変更する
3. **フォーマットの改変**: テンプレートで指定されたMarkdown形式を変更する
4. **独自セクションの追加**: テンプレートに存在しないセクションを追加する

#### 0.4.2 テンプレート参照の必須化

レポート生成を行う前に、必ず以下を実施：
1. テンプレートファイルをReadで読み込む
2. テンプレートの全セクション・全テーブル構造を確認する
3. 出力時にテンプレートと照合しながら記述する

---

## セクション1: データ構造分析の原則

### 1.1 テーブル構造の把握

**原則**: 関連するすべてのテーブルの構造を把握すること。

**調査項目**:
- テーブル名とその役割
- 主要なカラムとその意味
- リレーション（外部キー、belongsTo/hasMany等）
- 論理的な関連（同じエンティティを異なる観点で保持するテーブル等）

### 1.2 フィールド構造の分析（CRITICAL）

**原則**: 複合フィールド（ビットパターン、エンコードされた値等）は**各桁・各部分の意味を明確化**すること。

**記載形式の例**:
```markdown
### フィールド構造: [カラム名]（N桁）

| 桁位置 | 意味 | 値=1の場合 | 値=0の場合 |
|--------|------|-----------|-----------|
| 1桁目 | [意味A] | [状態A1] | [状態A0] |
| 2桁目 | [意味B] | [状態B1] | [状態B0] |

**パターン例**:
- `10000`: [説明]
- `11000`: [説明]
```

---

## セクション2: 定数・Enum分析の原則

### 2.1 コード体系の完全把握

**原則**: 関連するすべての定数・Enum定義を**完全に把握**すること。

**調査項目**:
- Enumクラス名とファイルパス
- 各定数の値と意味
- 定数間の関係性（階層、グループ等）

### 2.2 コード体系の可視化

**原則**: コード体系は**表形式で可視化**すること。

**記載形式の例**:
```markdown
### コード体系（[Enumファイル名]）

| コード | 定数名 | 説明 |
|--------|--------|------|
| `[値1]` | [定数名1] | [説明] |
| `[値2]` | [定数名2] | [説明] |
| `[値3]` | [定数名3] | [説明] |
```

### 2.3 パターン分類の明示

**原則**: 関連する処理パターン（チェックパターン等）を**明示的に分類**すること。

**記載形式の例**:
```markdown
### チェックパターン分類

| パターン | 対象コード | チェック内容 |
|----------|-----------|-------------|
| パターンA | [コード一覧] | [チェック内容] |
| パターンB | [コード一覧] | [チェック内容] |
```

---

## セクション3: バリデーションロジック分析の原則

### 3.1 コード引用の必須化（CRITICAL）

**原則**: バリデーションロジックは**実際のコードを引用**して記載すること。

**誤り例**:
```markdown
[資格名]の保有をチェックする。
```

**正しい例（記載形式）**:
```markdown
### [チェック名]（[行番号]）

```sql
[実際のSQLやコードを引用]
```

**判定条件**:
1. [条件1の説明]
2. [条件2の説明]
```

### 3.2 条件分岐の網羅

**原則**: すべての条件分岐パターンを**網羅的に記載**すること。

**記載形式の例**:

| 条件 | 結果 |
|------|------|
| [条件A] | エラー |
| [条件B] | 警告 |
| 上記以外 | 正常 |

---

## セクション4: ビジネスルール分析の原則

### 4.1 階層関係の明示

**原則**: 概念間の階層関係（上位・下位、包含関係等）を**明示**すること。

**記載形式の例**:
```markdown
### [概念名]の階層関係

```
[上位] > [中位] > [下位]
```

- [上位]を保有していれば[中位]のエラーは解除
- [補足説明]
```

### 4.2 特例処理の明示

**原則**: 特例・免除処理を**明示的に記載**すること。

**記載形式の例**:
```markdown
### [特例名]判定

```[言語]
[実際のコードを引用]
```

- [特例の説明1]
- [特例の説明2]
```

### 4.3 ビジネスルールのまとめ

**原則**: ビジネスルールは**条件と動作のセット**で記載すること。

**記載形式の例**:
```markdown
### ビジネスルールまとめ

#### [機能名]の条件

1. **[条件カテゴリ1]**（[詳細条件]）
2. **[条件カテゴリ2]**（以下のいずれか）:
   - [詳細条件A]
   - [詳細条件B]
```

---

## セクション5: 網羅性検証の原則

### 5.1 必須検証項目

レポート生成完了時に、以下の項目を必ず検証すること：

| 検証項目 | 確認内容 |
|---------|---------|
| 機能（ユースケース）特定 | PRから関連する機能を正しく特定したか |
| 機能全体の調査 | 特定した機能の処理全体を調査したか |
| データ構造把握 | テーブル・フィールドの意味を正確に把握したか |
| バリデーション抽出 | すべてのバリデーションルールを抽出したか |
| ビジネスルール分析 | すべてのビジネスルールを分析したか |

### 5.2 未達成時の対応

**重要**: 検証で未達成項目がある場合は**自動修正→再検証**を繰り返すこと。

1. 未達成の項目を特定
2. 不足している調査・分析を追加実施
3. 網羅性検証を再実行
4. すべて達成するまで繰り返す

**禁止事項**: 「後で追加する」「手動で修正する」という選択肢は存在しない。

---

## セクション6: よくある問題と対策

### 6.1 問題パターンと対策

| 問題パターン | 対策ルール |
|-------------|-----------|
| PR差分だけを分析して機能全体を見落とす | 機能（ユースケース）を特定し、その処理全体を調査 |
| ビジネスロジックの推測記載 | 実際のコード引用の必須化 |
| 条件分岐の一部だけ記載 | すべての分岐パターンを網羅 |

### 6.2 重点的に確認すべき箇所

1. **複合フィールドの各桁の意味**: ビットパターン、エンコード値等
2. **条件分岐の全パターン**: if/else、switch/caseのすべての分岐
3. **階層関係・包含関係**: 上位概念が下位を含むかどうか
4. **特例処理**: 通常フローと異なる処理パス
